# Visa Travel Agent Integration - Sequence Diagram

This diagram shows the complete flow of how a travel agent integrates with Visa's payment system to enable secure, passkey-authenticated payments for travel bookings.

## Flow Overview

```mermaid
sequenceDiagram
    participant User
    participant Agent
    participant Merchants
    box rgb(173, 216, 230) Visa Payment Platform
        participant VTS as Visa Token Service
        participant VIC as Visa Intelligent Commerce
        participant iFrame as Visa Auth iFrame
    end

    Note over User,iFrame: PHASE 1: User Onboarding (Travel Context)
    
    User->>Agent: Sign up & select travel experiences
    Agent->>Agent: Store user profile and travel intent

    Note over User,iFrame: PHASE 2: Payment Card Setup (One-time)
    
    User->>Agent: Provide card details (PAN, CVV2, expiry, billing address)
    Agent->>VTS: Enroll PAN
    VTS-->>Agent: Return enrollment ID
    
    Agent->>VTS: Provision token for enrolled PAN
    VTS-->>Agent: Return token ID + card metadata (last 4 digits, card art)
    Agent->>Agent: Store token ID linked to user profile

    Note over User,iFrame: PHASE 3: Passkey Setup (One-time)
    
    Agent->>iFrame: Request secure session token
    iFrame-->>Agent: Return secure token
    
    Agent->>VTS: Request device attestation (for payment)
    VTS-->>Agent: Return action=REGISTER (device binding needed)
    
    Agent->>VTS: Initiate device binding
    VTS-->>Agent: Return step-up options (SMS/Email OTP)
    
    Agent->>User: Request OTP verification
    User->>Agent: Provide OTP code
    Agent->>VTS: Validate OTP
    VTS-->>Agent: OTP confirmed
    
    Agent->>VTS: Request device attestation (for binding)
    VTS-->>Agent: Return payload for passkey creation
    
    Agent->>iFrame: Initiate passkey creation with payload
    iFrame->>User: Show "Create payment passkey" prompt
    User->>iFrame: Create passkey with PIN
    iFrame-->>Agent: Return passkey authentication data (fidoBlob)
    Agent->>Agent: Store passkey authentication token

    Note over User,iFrame: PHASE 4: Purchase Intent (When ready to book)
    
    User->>Agent: Ready to complete booking
    Agent->>Agent: Retrieve token ID, passkey data, and travel intent
    
    Agent->>iFrame: Request secure session token
    iFrame-->>Agent: Return secure token
    
    Agent->>VTS: Request device attestation (for payment)
    VTS-->>Agent: Return payload for authentication
    
    Agent->>iFrame: Authenticate with passkey
    iFrame->>User: Show "Verify payment passkey" prompt
    User->>iFrame: Enter passkey PIN
    iFrame-->>Agent: Return authentication data (fidoBlob)
    
    Agent->>VIC: Initiate purchase instruction (token + fidoBlob + amount)
    VIC-->>Agent: Return instruction ID

    Note over User,iFrame: PHASE 5: Complete Purchase
    
    Agent->>VIC: Request payment credentials (instruction ID + token ID)
    VIC-->>Agent: Return cryptogram in signed payload
    Agent->>Agent: Decode cryptogram from JWT payload
    
    Agent->>Merchants: Send payment credential (cryptogram)
    Merchants->>VIC: Process payment with cryptogram
    VIC-->>Merchants: Confirm payment successful
    Merchants-->>Agent: Booking confirmed
    
    Agent->>VIC: Publish transaction confirmation
    VIC-->>Agent: Acknowledgment
    
    Agent-->>User: Trip booked successfully!
```

## Key Points

### Focus: Visa Payment Integration
This diagram showcases Visa's secure payment flow using tokenization and passkey authentication. The travel booking context is just one example - **the payment pattern (Phases 2-5) works for any agent-based commerce**.

### One-Time Setup (Phases 2-3) - The Core Innovation
- **Phase 2**: Card tokenization via VTS (Visa Token Service)
  - Real PAN is enrolled and replaced with a secure token
  - Agent stores token ID, never the actual card number
- **Phase 3**: Passkey authentication setup
  - FIDO2-based passkey creation with device binding
  - OTP verification for additional security
  - Passkey data stored for future authentication

### Per-Transaction Flow (Phases 4-5) - Secure Payment Execution
- **Phase 4**: Passkey authentication + purchase intent
  - User verifies with passkey PIN (no card details needed)
  - VIC generates instruction ID for the transaction
- **Phase 5**: Cryptogram generation + payment processing
  - Fresh cryptogram generated for each transaction
  - Merchants process payment without seeing card details

### Security Benefits

- **Tokenization**: Real card number is replaced with a token via VTS
- **Passkey Authentication**: FIDO2-based authentication via Visa Auth iFrame
- **Cryptogram**: Payment credential generated by VIC for each transaction
- **No Card Storage**: Merchants receive cryptogram, not card details
