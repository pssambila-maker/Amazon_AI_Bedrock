# Visa Shopping Agent Integration - Sequence Diagram

This diagram shows how a shopping agent integrates with Visa's payment system to enable secure, passkey-authenticated payments for online purchases.

## Flow Overview

```mermaid
sequenceDiagram
    participant User
    participant Agent
    participant Merchants
    box rgb(173, 216, 230) Visa Payment Platform
        participant VTS as Visa Token Service
        participant VIC as Visa Intelligent Commerce
        participant iFrame as Visa Auth iFrame
    end

    Note over User,iFrame: PHASE 1: User Onboarding & Shopping
    
    User->>Agent: Sign up with shopping agent
    Agent->>Agent: Create user profile in database
    
    User->>Agent: Find products for me
    Agent->>Merchants: Search across retailers
    Merchants-->>Agent: Return product options
    Agent-->>User: Show curated product recommendations
    User->>Agent: Add items to cart
    Agent->>Agent: Store shopping cart in database

    Note over User,iFrame: PHASE 2: Payment Card Setup (One-time)
    
    User->>Agent: Provide card details (PAN, CVV2, expiry, billing address)
    Agent->>VTS: Enroll PAN
    VTS-->>Agent: Return enrollment ID
    
    Agent->>VTS: Provision token for enrolled PAN
    VTS-->>Agent: Return token ID + card metadata (last 4 digits, card art)
    Agent->>Agent: Store token ID linked to user profile

    Note over User,iFrame: PHASE 3: Passkey Setup (One-time)
    
    Agent->>iFrame: Request secure session token
    iFrame-->>Agent: Return secure token
    
    Agent->>VTS: Request device attestation (for payment)
    VTS-->>Agent: Return action=REGISTER (device binding needed)
    
    Agent->>VTS: Initiate device binding
    VTS-->>Agent: Return step-up options (SMS/Email OTP)
    
    Agent->>User: Request OTP verification
    User->>Agent: Provide OTP code
    Agent->>VTS: Validate OTP
    VTS-->>Agent: OTP confirmed
    
    Agent->>VTS: Request device attestation (for binding)
    VTS-->>Agent: Return payload for passkey creation
    
    Agent->>iFrame: Initiate passkey creation with payload
    iFrame->>User: Show "Create payment passkey" prompt
    User->>iFrame: Create passkey with PIN
    iFrame-->>Agent: Return passkey authentication data (fidoBlob)
    Agent->>Agent: Store passkey authentication token

    Note over User,iFrame: PHASE 4: Purchase Intent (When ready to checkout)
    
    User->>Agent: Proceed to checkout
    Agent->>Agent: Retrieve token ID, passkey data, and cart items
    
    Agent->>iFrame: Request secure session token
    iFrame-->>Agent: Return secure token
    
    Agent->>VTS: Request device attestation (for payment)
    VTS-->>Agent: Return payload for authentication
    
    Agent->>iFrame: Authenticate with passkey
    iFrame->>User: Show "Verify payment passkey" prompt
    User->>iFrame: Enter passkey PIN
    iFrame-->>Agent: Return authentication data (fidoBlob)
    
    Agent->>VIC: Initiate purchase instruction (token + fidoBlob + amount)
    VIC-->>Agent: Return instruction ID

    Note over User,iFrame: PHASE 5: Complete Purchase
    
    Agent->>VIC: Request payment credentials (instruction ID + token ID)
    VIC-->>Agent: Return cryptogram in signed payload
    Agent->>Agent: Decode cryptogram from JWT payload
    
    Agent->>Merchants: Send payment credential (cryptogram)
    Merchants->>VIC: Process payment with cryptogram
    VIC-->>Merchants: Confirm payment successful
    Merchants-->>Agent: Order confirmed
    
    Agent->>VIC: Publish transaction confirmation
    VIC-->>Agent: Acknowledgment
    
    Agent-->>User: Order placed successfully!
```

## Key Points

### One-Time Setup (Phases 2-3)
- User only needs to enroll their card and create a passkey once
- The agent stores the token ID and passkey authentication data
- Future purchases reuse these credentials

### Per-Transaction Flow (Phases 4-5)
- User authenticates with their passkey PIN
- Agent retrieves a fresh cryptogram for each transaction
- Merchants never see the actual card number, only the cryptogram

### Security Benefits

- **Tokenization**: Real card number is replaced with a token via VTS
- **Passkey Authentication**: PIN-based verification via Visa Auth iFrame
- **Cryptogram**: Payment credential generated by VIC for each transaction
- **No Card Storage**: Merchants receive cryptogram, not card details

### Shopping Agent Use Cases
- Personal shopping assistants
- Price comparison and deal finders
- Subscription management services
- Multi-retailer checkout aggregation
- AI-powered product recommendations
