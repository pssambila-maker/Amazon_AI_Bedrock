<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Dashboard - Professional Analytics</title>

    <!-- Chart.js for professional visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Bold & Colorful palette */
            --primary-color: #6366f1;
            --primary-dark: #4338ca;
            --primary-light: #a5b4fc;
            --primary-hover: #818cf8;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            --secondary-color: #64748b;

            /* Vibrant status colors */
            --success-color: #10b981;
            --success-bg: #d1fae5;
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);

            --warning-color: #f59e0b;
            --warning-bg: #fef3c7;
            --warning-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);

            --danger-color: #ef4444;
            --danger-bg: #fee2e2;
            --danger-gradient: linear-gradient(135deg, #f87171 0%, #ef4444 100%);

            --info-color: #3b82f6;
            --info-bg: #dbeafe;
            --info-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);

            /* Category-specific vibrant colors */
            --category-quality: #3b82f6;
            --category-quality-bg: #dbeafe;
            --category-quality-gradient: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%);

            --category-safety: #f43f5e;
            --category-safety-bg: #ffe4e6;
            --category-safety-gradient: linear-gradient(135deg, #fb7185 0%, #e11d48 100%);

            --category-performance: #a855f7;
            --category-performance-bg: #f3e8ff;
            --category-performance-gradient: linear-gradient(135deg, #c084fc 0%, #9333ea 100%);

            --category-agent: #10b981;
            --category-agent-bg: #d1fae5;
            --category-agent-gradient: linear-gradient(135deg, #34d399 0%, #059669 100%);

            --category-content: #f59e0b;
            --category-content-bg: #fef3c7;
            --category-content-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);

            /* Neutral grays with subtle tones */
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;

            --bg-color: #fafafa;
            --card-bg: #ffffff;
            --border-color: #e5e5e5;
            --text-primary: #171717;
            --text-secondary: #737373;
            --text-muted: #a3a3a3;

            /* Refined shadows with subtle depth */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-md: 0 2px 4px 0 rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 4px 8px 0 rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 8px 16px 0 rgba(0, 0, 0, 0.06);

            /* Spacing system - 4px base (reduced) */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 40px;
            --space-3xl: 48px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 15px;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: var(--space-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.03em;
            margin-bottom: 0.125rem;
        }

        .header p {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-weight: 400;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-xl) var(--space-lg);
        }

        .tabs {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab {
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9375rem;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--gray-50);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 700;
            background: linear-gradient(to top, rgba(99, 102, 241, 0.05), transparent);
        }

        .tab:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--gray-100);
        }

        .card-title {
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.015em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: var(--space-md);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            transition: height 0.3s;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            height: 6px;
        }

        .stat-card.success::before {
            background: var(--success-gradient);
        }

        .stat-card.warning::before {
            background: var(--warning-gradient);
        }

        .stat-card.info::before {
            background: var(--info-gradient);
        }

        .stat-label {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: var(--space-xs);
            font-weight: 700;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1;
            color: var(--text-primary);
            letter-spacing: -0.04em;
            margin-bottom: var(--space-xs);
        }

        .stat-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--space-xs);
            font-weight: 400;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: var(--space-md) 0;
        }

        .heatmap-container {
            overflow-x: auto;
            margin: var(--space-md) 0;
        }

        .heatmap {
            display: grid;
            gap: 2px;
            background: var(--border-color);
            padding: 2px;
            border-radius: 0.5rem;
        }

        .heatmap-cell {
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.25rem;
            transition: transform 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: var(--shadow-md);
        }

        .heatmap-header {
            background: var(--secondary-color);
            color: white;
            font-weight: 600;
        }

        .score-high {
            background: var(--success-bg);
            color: #047857;
            font-weight: 700;
            border: 1px solid #10b981;
        }
        .score-medium {
            background: var(--warning-bg);
            color: #b45309;
            font-weight: 700;
            border: 1px solid #f59e0b;
        }
        .score-low {
            background: var(--danger-bg);
            color: #dc2626;
            font-weight: 700;
            border: 1px solid #ef4444;
        }

        .category-section {
            margin-bottom: 2rem;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .category-header:hover {
            background: var(--border-color);
        }

        .category-name {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .category-badge {
            display: inline-block;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .category-quality { background: var(--category-quality-bg); color: var(--category-quality); font-weight: 600; border: 1px solid var(--category-quality); }
        .category-safety { background: var(--category-safety-bg); color: var(--category-safety); font-weight: 600; border: 1px solid var(--category-safety); }
        .category-performance { background: var(--category-performance-bg); color: var(--category-performance); font-weight: 600; border: 1px solid var(--category-performance); }
        .category-agent-and-tools { background: var(--category-agent-bg); color: var(--category-agent); font-weight: 600; border: 1px solid var(--category-agent); }
        .category-content { background: var(--category-content-bg); color: var(--category-content); font-weight: 600; border: 1px solid var(--category-content); }

        .evaluator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .evaluator-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.25rem;
        }

        .evaluator-name {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .evaluator-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .evaluator-stat:last-child {
            border-bottom: none;
        }

        .btn {
            padding: var(--space-xs) var(--space-md);
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
            letter-spacing: 0.005em;
        }

        .btn:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        th {
            padding: var(--space-sm) var(--space-md);
            text-align: left;
            font-weight: 700;
            color: var(--text-secondary);
            background: var(--gray-50);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: var(--gray-100);
        }

        th.sortable::after {
            content: '⇅';
            opacity: 0.3;
            margin-left: var(--space-xs);
            font-size: 0.75rem;
        }

        th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.8125rem;
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--gray-50);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 0.2rem var(--space-xs);
            border-radius: 6px;
            font-size: 0.6875rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .upload-section {
            background: var(--card-bg);
            border-radius: 0.875rem;
            padding: var(--space-xl);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .upload-section h2 {
            font-size: 1.25rem;
            margin-bottom: var(--space-sm);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .upload-section p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .upload-section code {
            background: var(--bg-color);
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
        }

        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
            padding: var(--space-xl) var(--space-lg);
            margin: var(--space-lg) 0;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-color);
        }

        .drop-zone:hover {
            border-color: var(--primary-color);
            background: rgba(79, 70, 229, 0.04);
        }

        .drop-zone-icon {
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
        }

        .success-message {
            background: var(--success-gradient);
            color: white;
            padding: var(--space-sm) var(--space-md);
            border-radius: 0.5rem;
            margin-top: var(--space-md);
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: var(--shadow-md);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 0.875rem;
            padding: var(--space-lg);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .modal-close {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1.125rem;
            color: var(--text-secondary);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .hidden {
            display: none;
        }

        .comparison-table {
            margin-top: 1.5rem;
        }

        .diff-positive {
            color: var(--success-color);
            font-weight: 600;
        }

        .diff-negative {
            color: var(--danger-color);
            font-weight: 600;
        }

        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: var(--card-bg);
            transition: all 0.15s ease;
        }

        .filter-group select:hover,
        .filter-group input:hover {
            border-color: var(--secondary-color);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state div {
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        /* Collapsible sections */
        .collapsible-section {
            margin: 1rem 0;
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border: 1px solid var(--border-color);
        }

        .collapsible-header:hover {
            background: var(--border-color);
        }

        .collapsible-toggle {
            margin-right: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .collapsible-toggle.expanded {
            transform: rotate(90deg);
        }

        .collapsible-title {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .collapsible-badge {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .collapsible-content {
            display: none;
            padding: 1rem 0 0 2rem;
        }

        .collapsible-content.expanded {
            display: block;
        }

        .section-level-session {
            background: #eff6ff;
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
        }

        .section-level-trace {
            margin-left: 0;
        }

        .section-level-span {
            margin-left: 1rem;
        }

        .evaluation-table {
            width: 100%;
            margin-top: 0.75rem;
        }

        .evaluation-table td {
            padding: 0.5rem;
            vertical-align: top;
        }

        .evaluation-table .eval-name {
            font-weight: 600;
            min-width: 180px;
        }

        .evaluation-table .eval-score {
            min-width: 80px;
        }

        .evaluation-table .eval-explanation {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .explanation-truncated {
            max-height: 3em;
            overflow: hidden;
            position: relative;
        }

        .explanation-full {
            white-space: pre-wrap;
        }

        .show-more-btn {
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .show-more-btn:hover {
            text-decoration: underline;
        }

        /* Search and Filter Styles */
        .search-filter-bar {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-lg) var(--space-sm) var(--space-xl);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--space-sm);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .filter-chips {
            display: flex;
            gap: var(--space-xs);
            flex-wrap: wrap;
            margin-top: var(--space-sm);
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 0.375rem var(--space-sm);
            background: var(--info-bg);
            color: var(--info-color);
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            border: 1px solid var(--info-color);
            animation: slideIn 0.2s;
        }

        .filter-chip-close {
            cursor: pointer;
            font-weight: 700;
            padding: 0 0.25rem;
        }

        .filter-chip-close:hover {
            opacity: 0.7;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-color);
        }

        .pagination-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .pagination-controls {
            display: flex;
            gap: var(--space-xs);
            align-items: center;
        }

        .pagination-btn {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-200);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Comparison Mode */
        .comparison-selector {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: var(--space-md);
        }

        .comparison-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .compare-button {
            margin-left: auto;
        }

        /* Split View Layout */
        .split-view-container {
            display: flex;
            gap: var(--space-lg);
            min-height: 500px;
        }

        .split-view-left {
            flex: 1;
            min-width: 0;
            overflow: auto;
        }

        .split-view-right {
            width: 450px;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .split-view-right.collapsed {
            width: 0;
            overflow: hidden;
            opacity: 0;
        }

        /* Side Panel */
        .side-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-lg);
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
            position: sticky;
            top: var(--space-lg);
            box-shadow: var(--shadow-lg);
        }

        .side-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .side-panel-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .side-panel-close {
            background: var(--gray-100);
            border: none;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .side-panel-close:hover {
            background: var(--danger-color);
            color: white;
        }

        .side-panel-section {
            margin-bottom: var(--space-lg);
        }

        .side-panel-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: var(--space-sm);
        }

        .side-panel-content {
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .side-panel-code {
            background: var(--gray-50);
            padding: var(--space-sm);
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.8125rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
        }

        .side-panel-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }

        .side-panel-metric {
            background: var(--gray-50);
            padding: var(--space-sm);
            border-radius: 6px;
            text-align: center;
        }

        .side-panel-metric-label {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .side-panel-metric-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .side-panel-tools {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .side-panel-tool-badge {
            background: var(--category-agent-bg);
            color: var(--category-agent);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--category-agent);
        }

        /* Row Selection */
        .trace-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .trace-row:hover {
            background: var(--info-bg) !important;
        }

        .trace-row.selected {
            background: var(--info-bg) !important;
            border-left: 3px solid var(--info-color);
        }

        .trace-row-group-start {
            border-top: 2px solid var(--gray-300);
        }

        .session-id-cell {
            background: var(--gray-50);
            font-weight: 600;
        }

        /* Truncated text with tooltip */
        .truncated-text {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: help;
        }

        .tool-badge {
            display: inline-block;
            background: var(--category-agent-bg);
            color: var(--category-agent);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
            border: 1px solid var(--category-agent);
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus visible for keyboard navigation */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 1.125rem;
            }

            .header p {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: var(--space-sm) 0;
            }

            .header h1 {
                font-size: 1rem;
            }

            .container {
                padding: var(--space-lg) var(--space-md);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }

            .stat-card {
                padding: var(--space-sm);
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .evaluator-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: var(--space-xs);
            }

            .tab {
                padding: var(--space-sm);
                font-size: 0.875rem;
            }

            .search-filter-bar {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-sm);
            }

            .search-box {
                min-width: 100%;
            }

            .pagination {
                flex-direction: column;
                gap: var(--space-md);
            }

            .card {
                padding: var(--space-sm);
            }

            .chart-container {
                height: 250px;
            }

            td, th {
                padding: var(--space-xs) var(--space-sm);
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>AgentCore Evaluation OnDemand Dashboard</h1>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="uploadSection" class="upload-section">
            <h2>No Evaluation Data Yet</h2>
            <p>Run evaluations with <code>auto_create_dashboard=True</code> to automatically populate this dashboard</p>

            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                </div>
                <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
                    Run your first evaluation to get started
                </div>
                <div style="color: var(--text-secondary);">Or drag and drop existing JSON files here</div>
            </div>

            <input type="file" id="fileInput" multiple accept=".json" style="display: none;">

            <button class="btn" onclick="document.getElementById('fileInput').click()">
                Select Files
            </button>

            <div id="successMessage" class="success-message hidden"></div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">Overview</button>
                <button class="tab" onclick="switchTab('sessions')">Sessions</button>
                <button class="tab" onclick="switchTab('experiments')">Experiments</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Unique Sessions</div>
                        <div class="stat-value" id="totalSessions">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Evaluators</div>
                        <div class="stat-value" id="totalEvaluations">0</div>
                        <div class="stat-subtitle">Distinct evaluator types</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Average Score</div>
                        <div class="stat-value" id="avgScore">0.00</div>
                        <div class="stat-subtitle">All evaluators</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">Total Tokens</div>
                        <div class="stat-value" id="totalTokens">0</div>
                        <div class="stat-subtitle" id="tokenBreakdown">Input: 0 | Output: 0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Score Distribution</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="scoreDistChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Latency Distribution</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="latencyDistChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Average Scores by Evaluator</h2>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="evaluatorScoresChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Evaluator Performance Heatmap</h2>
                    </div>
                    <div class="heatmap-container" id="heatmapContainer"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Category Performance</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div id="categoryScoresTable" style="margin-top: 1.5rem;"></div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessions" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Session Details</h2>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportToCSV()">Export CSV</button>
                        </div>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div class="search-filter-bar">
                        <div class="search-box">
                            <span class="search-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35"></path>
                                </svg>
                            </span>
                            <input type="text" class="search-input" id="sessionsSearch" placeholder="Search sessions by ID, input, output, or trace..." oninput="handleSessionsSearch()">
                        </div>
                        <select class="filter-group select" id="sessionsEvaluatorFilter" onchange="handleSessionsFilter()" style="padding: var(--space-sm) var(--space-md); border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.875rem;">
                            <option value="">All Evaluators</option>
                        </select>
                        <select class="filter-group select" id="sessionsScoreFilter" onchange="handleSessionsFilter()" style="padding: var(--space-sm) var(--space-md); border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.875rem;">
                            <option value="">All Scores</option>
                            <option value="high">High (≥0.8)</option>
                            <option value="medium">Medium (0.5-0.79)</option>
                            <option value="low">Low (<0.5)</option>
                        </select>
                    </div>

                    <!-- Filter Chips -->
                    <div id="sessionsFilterChips" class="filter-chips"></div>

                    <!-- Split View Container -->
                    <div class="split-view-container">
                        <!-- Table Section (Left) -->
                        <div class="split-view-left">
                            <div id="sessionsTable"></div>

                            <!-- Pagination -->
                            <div id="sessionsPagination" class="pagination hidden">
                                <div class="pagination-info" id="sessionsPageInfo"></div>
                                <div class="pagination-controls" id="sessionsPageControls"></div>
                            </div>
                        </div>

                        <!-- Side Panel (Right) -->
                        <div class="split-view-right collapsed" id="traceDetailPanel">
                            <div class="side-panel">
                                <div class="side-panel-header">
                                    <div class="side-panel-title">Trace Details</div>
                                    <button class="side-panel-close" onclick="closeSidePanel()">&times;</button>
                                </div>
                                <div id="sidePanelContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Experiments Tab -->
            <div id="experiments" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Experiment Comparison</h2>
                    </div>
                    <div id="experimentsContent"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal for detailed views -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Load dashboard data if available -->
    <script src="dashboard_data.js" onerror="console.log('No dashboard_data.js found')"></script>

    <script>
        // Global state
        let evaluationData = [];
        let allResults = [];
        let charts = {};

        // Advanced state management
        let globalFilters = {
            search: '',
            evaluator: '',
            category: '',
            scoreRange: ''
        };

        let paginationState = {
            currentPage: 1,
            itemsPerPage: 25,
            totalItems: 0
        };

        let comparisonMode = {
            enabled: false,
            selectedSessions: []
        };

        let sortState = {
            column: null,
            direction: 'asc'
        };

        // Evaluator categories
        const EVALUATOR_CATEGORIES = {
            'Quality': ['Correctness', 'Helpfulness', 'ResponseRelevance', 'Coherence'],
            'Safety': ['Harmfulness', 'Stereotyping', 'Refusal'],
            'Performance': ['Conciseness', 'InstructionFollowing'],
            'Agent & Tools': ['GoalSuccessRate', 'ToolSelectionAccuracy', 'ToolParameterAccuracy'],
            'Content': ['Faithfulness']
        };

        function getEvaluatorCategory(evaluatorId) {
            const name = evaluatorId.replace('Builtin.', '');
            for (const [category, evaluators] of Object.entries(EVALUATOR_CATEGORIES)) {
                if (evaluators.includes(name)) {
                    return category;
                }
            }
            return 'Other';
        }

        // File handling
        function setupFileHandlers() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--primary-color)';
                dropZone.style.background = '#eff6ff';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border-color)';
                dropZone.style.background = 'var(--bg-color)';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border-color)';
                dropZone.style.background = 'var(--bg-color)';
                handleFileSelect(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));
        }

        function handleFileSelect(files) {
            if (!files || files.length === 0) return;

            const tempData = [];
            let filesLoaded = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.name.endsWith('.json')) continue;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        tempData.push(data);
                        filesLoaded++;

                        if (filesLoaded === files.length) {
                            evaluationData = tempData;
                            showSuccess(`Loaded ${evaluationData.length} session(s)`);
                            initializeDashboard();
                        }
                    } catch (err) {
                        console.error(`Error parsing ${file.name}:`, err);
                    }
                };
                reader.readAsText(file);
            }
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function initializeDashboard() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            processData();
            renderAll();
        }

        // Data processing
        function processData() {
            allResults = [];
            evaluationData.forEach(session => {
                if (session.results) {
                    session.results.forEach(result => {
                        allResults.push({
                            ...result,
                            session_id: session.session_id,
                            metadata: session.metadata || {},
                            evaluation_runs: session.evaluation_runs || 1,
                            source_files: session.source_files || []
                        });
                    });
                }
            });
        }

        // Search and Filter Functions
        function filterSessions(sessions, filters) {
            return sessions.filter(session => {
                // Search filter
                if (filters.search) {
                    const searchLower = filters.search.toLowerCase();
                    const matchesId = session.session_id.toLowerCase().includes(searchLower);
                    const matchesMetadata = session.metadata && JSON.stringify(session.metadata).toLowerCase().includes(searchLower);
                    const matchesEvaluator = session.results && session.results.some(r =>
                        r.evaluator_id.toLowerCase().includes(searchLower)
                    );
                    if (!matchesId && !matchesMetadata && !matchesEvaluator) return false;
                }

                // Evaluator filter
                if (filters.evaluator) {
                    const hasEvaluator = session.results && session.results.some(r =>
                        r.evaluator_id === filters.evaluator
                    );
                    if (!hasEvaluator) return false;
                }

                // Score range filter
                if (filters.scoreRange) {
                    const validScores = session.results?.filter(r => r.value !== null && r.value !== undefined) || [];
                    if (validScores.length === 0) return false;
                    const avgScore = validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length;

                    if (filters.scoreRange === 'high' && avgScore < 0.8) return false;
                    if (filters.scoreRange === 'medium' && (avgScore < 0.5 || avgScore >= 0.8)) return false;
                    if (filters.scoreRange === 'low' && avgScore >= 0.5) return false;
                }

                return true;
            });
        }

        function sortData(data, column, direction) {
            if (!column) return data;

            return [...data].sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'session_id':
                        aVal = a.session_id;
                        bVal = b.session_id;
                        break;
                    case 'eval_runs':
                        aVal = a.evaluation_runs || 1;
                        bVal = b.evaluation_runs || 1;
                        break;
                    case 'evaluations':
                        aVal = a.results?.length || 0;
                        bVal = b.results?.length || 0;
                        break;
                    case 'avg_score':
                        const aScores = a.results?.filter(r => r.value !== null && r.value !== undefined) || [];
                        const bScores = b.results?.filter(r => r.value !== null && r.value !== undefined) || [];
                        aVal = aScores.length > 0 ? aScores.reduce((sum, r) => sum + r.value, 0) / aScores.length : 0;
                        bVal = bScores.length > 0 ? bScores.reduce((sum, r) => sum + r.value, 0) / bScores.length : 0;
                        break;
                    default:
                        return 0;
                }

                if (typeof aVal === 'string') {
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        function paginateData(data, page, itemsPerPage) {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            return data.slice(startIndex, endIndex);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Search and filter handlers
        const handleSessionsSearch = debounce(function() {
            globalFilters.search = document.getElementById('sessionsSearch').value;
            paginationState.currentPage = 1;
            renderSessions();
        }, 300);

        function handleSessionsFilter() {
            globalFilters.evaluator = document.getElementById('sessionsEvaluatorFilter').value;
            globalFilters.scoreRange = document.getElementById('sessionsScoreFilter').value;
            paginationState.currentPage = 1;
            renderSessions();
            updateFilterChips();
        }

        function updateFilterChips() {
            const container = document.getElementById('sessionsFilterChips');
            if (!container) return;

            const chips = [];

            if (globalFilters.search) {
                chips.push({
                    label: `Search: "${globalFilters.search}"`,
                    key: 'search'
                });
            }
            if (globalFilters.evaluator) {
                const evalName = globalFilters.evaluator.replace('Builtin.', '');
                chips.push({
                    label: `Evaluator: ${evalName}`,
                    key: 'evaluator'
                });
            }
            if (globalFilters.scoreRange) {
                const labels = { high: 'High Score', medium: 'Medium Score', low: 'Low Score' };
                chips.push({
                    label: labels[globalFilters.scoreRange],
                    key: 'scoreRange'
                });
            }

            if (chips.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = chips.map(chip => `
                <div class="filter-chip">
                    ${chip.label}
                    <span class="filter-chip-close" onclick="removeFilter('${chip.key}')">&times;</span>
                </div>
            `).join('');
        }

        function removeFilter(key) {
            globalFilters[key] = '';
            if (key === 'search') document.getElementById('sessionsSearch').value = '';
            if (key === 'evaluator') document.getElementById('sessionsEvaluatorFilter').value = '';
            if (key === 'scoreRange') document.getElementById('sessionsScoreFilter').value = '';
            paginationState.currentPage = 1;
            renderSessions();
            updateFilterChips();
        }

        // Render all sections
        function renderAll() {
            renderOverview();
            renderSessions();
            renderExperiments();
        }

        // Overview rendering
        function renderOverview() {
            const totalSessions = evaluationData.length;
            const totalEvaluations = [...new Set(allResults.map(r => r.evaluator_id))].length;
            const validScores = allResults.filter(r => r.value !== null && r.value !== undefined);
            const avgScore = validScores.length > 0
                ? (validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length).toFixed(2)
                : '0.00';
            const inputTokens = allResults.reduce((sum, r) => sum + (r.token_usage?.inputTokens || 0), 0);
            const outputTokens = allResults.reduce((sum, r) => sum + (r.token_usage?.outputTokens || 0), 0);
            const totalTokens = allResults.reduce((sum, r) => sum + (r.token_usage?.totalTokens || 0), 0);

            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('totalEvaluations').textContent = totalEvaluations;
            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('totalTokens').textContent = totalTokens.toLocaleString();
            document.getElementById('tokenBreakdown').textContent = `Input: ${inputTokens.toLocaleString()} | Output: ${outputTokens.toLocaleString()}`;

            renderScoreDistribution();
            renderLatencyDistribution();
            renderEvaluatorScoresChart();
            renderHeatmap();
            renderCategoryChart();
        }

        function renderScoreDistribution() {
            const canvas = document.getElementById('scoreDistChart');
            const ctx = canvas.getContext('2d');

            const validScores = allResults.filter(r => r.value !== null && r.value !== undefined);
            const bins = Array(10).fill(0);
            validScores.forEach(r => {
                const binIndex = Math.min(Math.floor(r.value * 10), 9);
                bins[binIndex]++;
            });

            const total = bins.reduce((a, b) => a + b, 0);

            if (charts.scoreDist) charts.scoreDist.destroy();

            charts.scoreDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map((_, i) => `${(i * 0.1).toFixed(1)}-${((i + 1) * 0.1).toFixed(1)}`),
                    datasets: [{
                        label: 'Evaluations',
                        data: bins,
                        backgroundColor: bins.map((_, i) => {
                            const score = (i + 0.5) / 10;
                            if (score >= 0.8) return 'rgba(16, 185, 129, 0.85)';
                            if (score >= 0.5) return 'rgba(245, 158, 11, 0.85)';
                            return 'rgba(239, 68, 68, 0.85)';
                        }),
                        borderColor: bins.map((_, i) => {
                            const score = (i + 0.5) / 10;
                            if (score >= 0.8) return '#10b981';
                            if (score >= 0.5) return '#f59e0b';
                            return '#ef4444';
                        }),
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const minScore = index * 0.1;
                            const maxScore = (index + 1) * 0.1;
                            console.log(`Clicked on range ${minScore.toFixed(1)}-${maxScore.toFixed(1)}`);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(23, 23, 23, 0.95)',
                            padding: 16,
                            titleColor: '#fff',
                            bodyColor: '#fafafa',
                            borderColor: 'rgba(229, 229, 229, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: '600', family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            bodyFont: { size: 12, family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            displayColors: false,
                            callbacks: {
                                title: (items) => `Score Range: ${items[0].label}`,
                                label: (context) => {
                                    const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                                    return `${context.parsed.y} evaluations (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#737373',
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, sans-serif' }
                            },
                            grid: {
                                color: 'rgba(229, 229, 229, 0.5)',
                                drawBorder: false
                            },
                            border: { display: false }
                        },
                        x: {
                            ticks: {
                                color: '#737373',
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, sans-serif' }
                            },
                            grid: { display: false },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        function renderLatencyDistribution() {
            const canvas = document.getElementById('latencyDistChart');
            const ctx = canvas.getContext('2d');

            // Collect all latency values from traces
            const latencies = [];
            evaluationData.forEach(session => {
                if (session.traces && Array.isArray(session.traces)) {
                    session.traces.forEach(trace => {
                        if (trace.latency_ms && trace.latency_ms > 0) {
                            latencies.push(trace.latency_ms);
                        }
                    });
                }
            });

            if (latencies.length === 0) {
                // No latency data available
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillStyle = '#737373';
                ctx.textAlign = 'center';
                ctx.fillText('No latency data available', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Calculate bins for histogram (10 bins)
            const minLatency = Math.min(...latencies);
            const maxLatency = Math.max(...latencies);
            const binSize = (maxLatency - minLatency) / 10;
            const bins = Array(10).fill(0);

            latencies.forEach(latency => {
                const binIndex = Math.min(Math.floor((latency - minLatency) / binSize), 9);
                bins[binIndex]++;
            });

            const labels = bins.map((_, i) => {
                const start = minLatency + i * binSize;
                const end = start + binSize;
                return `${Math.round(start)}-${Math.round(end)}`;
            });

            if (charts.latencyDist) charts.latencyDist.destroy();

            charts.latencyDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Traces',
                        data: bins,
                        backgroundColor: 'rgba(99, 102, 241, 0.85)',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(23, 23, 23, 0.95)',
                            padding: 16,
                            titleColor: '#fff',
                            bodyColor: '#fafafa',
                            borderColor: 'rgba(229, 229, 229, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: '600', family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            bodyFont: { size: 12, family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            displayColors: false,
                            callbacks: {
                                title: (items) => `Latency Range: ${items[0].label} ms`,
                                label: (context) => `${context.parsed.y} trace${context.parsed.y !== 1 ? 's' : ''}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#737373',
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, sans-serif' }
                            },
                            grid: {
                                color: 'rgba(229, 229, 229, 0.5)',
                                drawBorder: false
                            },
                            border: { display: false }
                        },
                        x: {
                            ticks: {
                                color: '#737373',
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, sans-serif' },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { display: false },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        function renderEvaluatorScoresChart() {
            const canvas = document.getElementById('evaluatorScoresChart');
            const ctx = canvas.getContext('2d');

            const evaluatorMap = {};
            allResults.forEach(r => {
                if (r.value !== null && r.value !== undefined) {
                    if (!evaluatorMap[r.evaluator_id]) {
                        evaluatorMap[r.evaluator_id] = { sum: 0, count: 0 };
                    }
                    evaluatorMap[r.evaluator_id].sum += r.value;
                    evaluatorMap[r.evaluator_id].count++;
                }
            });

            const evaluators = Object.entries(evaluatorMap)
                .map(([id, data]) => ({
                    id: id.replace('Builtin.', ''),
                    fullId: id,
                    avg: data.sum / data.count,
                    count: data.count
                }))
                .sort((a, b) => b.avg - a.avg);

            if (charts.evaluatorScores) charts.evaluatorScores.destroy();

            charts.evaluatorScores = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: evaluators.map(e => e.id),
                    datasets: [{
                        label: 'Average Score',
                        data: evaluators.map(e => e.avg),
                        backgroundColor: evaluators.map(e =>
                            e.avg >= 0.8 ? 'rgba(16, 185, 129, 0.85)' :
                            e.avg >= 0.5 ? 'rgba(245, 158, 11, 0.85)' :
                            'rgba(239, 68, 68, 0.85)'
                        ),
                        borderColor: evaluators.map(e =>
                            e.avg >= 0.8 ? '#10b981' :
                            e.avg >= 0.5 ? '#f59e0b' :
                            '#ef4444'
                        ),
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const evaluator = evaluators[index];
                            console.log(`Clicked on evaluator: ${evaluator.id}`);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(23, 23, 23, 0.95)',
                            padding: 16,
                            titleColor: '#fff',
                            bodyColor: '#fafafa',
                            borderColor: 'rgba(229, 229, 229, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: '600', family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            bodyFont: { size: 12, family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            displayColors: false,
                            callbacks: {
                                title: (items) => items[0].label,
                                label: (context) => {
                                    const evaluator = evaluators[context.dataIndex];
                                    return [
                                        `Average Score: ${context.parsed.x.toFixed(3)}`,
                                        `Total Evaluations: ${evaluator.count}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                color: '#737373',
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, sans-serif' }
                            },
                            grid: {
                                color: 'rgba(229, 229, 229, 0.5)',
                                drawBorder: false
                            },
                            border: { display: false }
                        },
                        y: {
                            ticks: {
                                color: '#171717',
                                font: { size: 12, weight: '500', family: '-apple-system, BlinkMacSystemFont, sans-serif' }
                            },
                            grid: { display: false },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');

            const evaluatorIds = [...new Set(allResults.map(r => r.evaluator_id))];

            if (evaluatorIds.length === 0 || evaluationData.length === 0) {
                container.innerHTML = '<div class="empty-state">No data available for heatmap</div>';
                return;
            }

            // Group sessions by experiment ID and aggregate scores
            const experimentMap = {};
            evaluationData.forEach(session => {
                const experimentId = session.metadata?.experiment || 'default';

                if (!experimentMap[experimentId]) {
                    experimentMap[experimentId] = {
                        scores: {},
                        sessionCount: 0
                    };
                }

                experimentMap[experimentId].sessionCount++;

                // Aggregate scores for this experiment
                (session.results || []).forEach(result => {
                    if (result.value !== null && result.value !== undefined) {
                        if (!experimentMap[experimentId].scores[result.evaluator_id]) {
                            experimentMap[experimentId].scores[result.evaluator_id] = [];
                        }
                        experimentMap[experimentId].scores[result.evaluator_id].push(result.value);
                    }
                });
            });

            // Sort experiments alphabetically
            const experiments = Object.keys(experimentMap).sort();

            // TRANSPOSED: Experiments are rows, evaluators are columns
            let html = '<div class="heatmap" style="grid-template-columns: 200px repeat(' + evaluatorIds.length + ', 1fr);">';

            // Header row: "Experiment" label + evaluator names
            html += '<div class="heatmap-cell heatmap-header">Experiment</div>';
            evaluatorIds.forEach(evalId => {
                html += `<div class="heatmap-cell heatmap-header">${evalId.replace('Builtin.', '')}</div>`;
            });

            // Data rows: Each experiment becomes a row
            experiments.forEach(experimentId => {
                const expData = experimentMap[experimentId];
                const displayLabel = experimentId === 'default' ? `default (${expData.sessionCount} runs)` : `${experimentId} (${expData.sessionCount} runs)`;

                html += `<div class="heatmap-cell heatmap-header">${displayLabel}</div>`;

                evaluatorIds.forEach(evalId => {
                    const scores = expData.scores[evalId] || [];
                    const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : null;

                    if (avg !== null) {
                        const scoreClass = avg >= 0.8 ? 'score-high' : avg >= 0.5 ? 'score-medium' : 'score-low';
                        html += `<div class="heatmap-cell ${scoreClass}">${avg.toFixed(2)}</div>`;
                    } else {
                        html += '<div class="heatmap-cell" style="background: #e2e8f0;">N/A</div>';
                    }
                });
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderCategoryChart() {
            const canvas = document.getElementById('categoryChart');
            const ctx = canvas.getContext('2d');

            const categoryScores = {};
            allResults.forEach(r => {
                if (r.value !== null && r.value !== undefined) {
                    const category = getEvaluatorCategory(r.evaluator_id);
                    if (!categoryScores[category]) categoryScores[category] = { sum: 0, count: 0 };
                    categoryScores[category].sum += r.value;
                    categoryScores[category].count++;
                }
            });

            const categories = Object.keys(categoryScores);
            const avgScores = categories.map(cat => categoryScores[cat].sum / categoryScores[cat].count);

            if (charts.category) charts.category.destroy();

            charts.category = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Average Score',
                        data: avgScores,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.85)',
                            'rgba(244, 63, 94, 0.85)',
                            'rgba(168, 85, 247, 0.85)',
                            'rgba(16, 185, 129, 0.85)',
                            'rgba(245, 158, 11, 0.85)'
                        ],
                        borderColor: [
                            '#3b82f6',
                            '#f43f5e',
                            '#a855f7',
                            '#10b981',
                            '#f59e0b'
                        ],
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(23, 23, 23, 0.95)',
                            padding: 16,
                            titleColor: '#fff',
                            bodyColor: '#fafafa',
                            borderColor: 'rgba(229, 229, 229, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: '600', family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            bodyFont: { size: 12, family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' },
                            displayColors: false,
                            callbacks: {
                                title: (items) => items[0].label,
                                label: (context) => `Average Score: ${context.parsed.y.toFixed(3)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                color: '#737373',
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, sans-serif' }
                            },
                            grid: {
                                color: 'rgba(229, 229, 229, 0.5)',
                                drawBorder: false
                            },
                            border: { display: false }
                        },
                        x: {
                            ticks: {
                                color: '#171717',
                                font: { size: 12, weight: '500', family: '-apple-system, BlinkMacSystemFont, sans-serif' }
                            },
                            grid: { display: false },
                            border: { display: false }
                        }
                    }
                }
            });

            // Add scores table
            const tableContainer = document.getElementById('categoryScoresTable');
            let html = '<table><thead><tr><th>Category</th><th>Average Score</th><th>Evaluators</th></tr></thead><tbody>';

            categories.forEach(category => {
                const data = categoryScores[category];
                const avgScore = data.sum / data.count;
                const scoreClass = avgScore >= 0.8 ? 'badge score-high' : avgScore >= 0.5 ? 'badge score-medium' : 'badge score-low';

                html += '<tr>';
                html += `<td><strong>${category}</strong></td>`;
                html += `<td><span class="${scoreClass}">${avgScore.toFixed(3)}</span></td>`;
                html += `<td>${data.count} evaluation${data.count !== 1 ? 's' : ''}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // Helper: Extract first user message from messages array
        function extractUserInput(messages) {
            if (!Array.isArray(messages) || messages.length === 0) return '';

            for (const msg of messages) {
                if (msg.role === 'user') {
                    const content = msg.content;
                    if (typeof content === 'string') {
                        return content;
                    } else if (typeof content === 'object' && content.content) {
                        // Handle nested content structure
                        try {
                            const parsed = typeof content.content === 'string' ? JSON.parse(content.content) : content.content;
                            if (Array.isArray(parsed) && parsed[0] && parsed[0].text) {
                                return parsed[0].text;
                            }
                        } catch {
                            // Return full content without truncation
                            return String(content.content);
                        }
                    }
                }
            }
            return '';
        }

        // Helper: Extract assistant output from messages array
        function extractAssistantOutput(messages) {
            if (!Array.isArray(messages) || messages.length === 0) return '';

            // Get last assistant message
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                if (msg.role === 'assistant') {
                    const content = msg.content;
                    // Handle various content structures
                    if (typeof content === 'string') {
                        return content;
                    } else if (typeof content === 'object') {
                        // Check for message property
                        if (content.message) {
                            return content.message;
                        }
                        // Check for nested content structure (similar to input handling)
                        if (content.content) {
                            try {
                                const parsed = typeof content.content === 'string' ? JSON.parse(content.content) : content.content;
                                if (Array.isArray(parsed) && parsed[0] && parsed[0].text) {
                                    return parsed[0].text;
                                }
                            } catch {
                                return String(content.content);
                            }
                        }
                        // Check for text property directly
                        if (content.text) {
                            return content.text;
                        }
                    }
                }
            }
            return '';
        }

        // Helper: Format tools for display
        function formatToolsDisplay(toolsUsed) {
            if (!toolsUsed || Object.keys(toolsUsed).length === 0) {
                return '<span style="color: var(--text-muted);">—</span>';
            }

            let html = '';
            Object.entries(toolsUsed).forEach(([tool, count]) => {
                html += `<span class="tool-badge">${tool} (${count})</span>`;
            });
            return html;
        }

        // Sessions rendering with trace-level rows
        function renderSessions() {
            const container = document.getElementById('sessionsTable');

            // Populate evaluator filter dropdown
            const evaluatorFilter = document.getElementById('sessionsEvaluatorFilter');
            if (evaluatorFilter && evaluatorFilter.options.length === 1) {
                const uniqueEvaluators = [...new Set(allResults.map(r => r.evaluator_id))].sort();
                uniqueEvaluators.forEach(evalId => {
                    const option = document.createElement('option');
                    option.value = evalId;
                    option.textContent = evalId.replace('Builtin.', '');
                    evaluatorFilter.appendChild(option);
                });
            }

            if (evaluationData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>No sessions found</div></div>';
                document.getElementById('sessionsPagination').classList.add('hidden');
                return;
            }

            // Flatten sessions to trace-level entries
            let traceEntries = [];
            evaluationData.forEach(session => {
                if (session.traces && session.traces.length > 0) {
                    session.traces.forEach(trace => {
                        traceEntries.push({
                            ...trace,
                            session_metadata: session.metadata,
                            evaluation_runs: session.evaluation_runs
                        });
                    });
                } else {
                    // Fallback for sessions without trace data
                    traceEntries.push({
                        session_id: session.session_id,
                        trace_id: 'N/A',
                        input: [],
                        output: [],
                        tools_used: {},
                        results: session.results || [],
                        session_metadata: session.metadata,
                        evaluation_runs: session.evaluation_runs,
                        total_tokens: 0
                    });
                }
            });

            // Apply filters
            let filteredData = filterTraces(traceEntries, globalFilters);

            // Update pagination state
            paginationState.totalItems = filteredData.length;

            // Apply pagination
            const paginatedData = paginateData(filteredData, paginationState.currentPage, paginationState.itemsPerPage);

            if (filteredData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>No traces match the current filters</div></div>';
                document.getElementById('sessionsPagination').classList.add('hidden');
                return;
            }

            // Build table with trace-level rows
            let html = '<table><thead><tr>';
            html += '<th>Session ID</th>';
            html += '<th>Trace ID</th>';
            html += '<th style="min-width: 180px;">Input</th>';
            html += '<th style="min-width: 180px;">Output</th>';
            html += '<th>Tools Used</th>';
            html += '<th>Latency (ms)</th>';
            html += '<th>Input Tokens</th>';
            html += '<th>Output Tokens</th>';
            html += '<th>Evaluations</th>';
            html += '<th>Avg Score</th>';
            html += '</tr></thead><tbody>';

            let lastSessionId = null;
            paginatedData.forEach((trace, index) => {
                const isNewSession = trace.session_id !== lastSessionId;
                lastSessionId = trace.session_id;

                const validScores = trace.results.filter(r => r.value !== null && r.value !== undefined);
                const avgScore = validScores.length > 0 ? validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length : 0;
                const scoreClass = avgScore >= 0.8 ? 'badge score-high' : avgScore >= 0.5 ? 'badge score-medium' : 'badge score-low';

                const userInput = extractUserInput(trace.input);
                const assistantOutput = extractAssistantOutput(trace.output);

                const rowClass = `trace-row ${isNewSession ? 'trace-row-group-start' : ''}`;
                const traceKey = `${trace.session_id}___${trace.trace_id}`;

                html += `<tr class="${rowClass}" onclick="selectTrace('${traceKey}', ${index})">`;
                html += `<td class="${isNewSession ? 'session-id-cell' : ''}"><code style="font-size: 0.75rem; background: var(--gray-100); padding: 0.2rem 0.4rem; border-radius: 4px;">${trace.session_id.substring(0, 12)}...</code></td>`;
                html += `<td><code style="font-size: 0.75rem; background: var(--gray-100); padding: 0.2rem 0.4rem; border-radius: 4px;">${trace.trace_id !== 'N/A' ? trace.trace_id.substring(0, 12) + '...' : 'N/A'}</code></td>`;
                html += `<td><div class="truncated-text" title="${userInput}">${userInput.substring(0, 80)}${userInput.length > 80 ? '...' : ''}</div></td>`;
                html += `<td><div class="truncated-text" title="${assistantOutput}">${assistantOutput.substring(0, 80)}${assistantOutput.length > 80 ? '...' : ''}</div></td>`;
                html += `<td>${formatToolsDisplay(trace.tools_used)}</td>`;
                html += `<td><span style="font-size: 0.75rem;">${trace.latency_ms ? trace.latency_ms.toLocaleString(undefined, {maximumFractionDigits: 0}) : '—'}</span></td>`;
                html += `<td><span style="font-size: 0.75rem;">${(trace.input_tokens || 0) > 0 ? trace.input_tokens.toLocaleString() : '—'}</span></td>`;
                html += `<td><span style="font-size: 0.75rem;">${(trace.output_tokens || 0) > 0 ? trace.output_tokens.toLocaleString() : '—'}</span></td>`;
                html += `<td>${trace.results.length}</td>`;
                html += `<td><span class="${scoreClass}">${avgScore > 0 ? avgScore.toFixed(2) : 'N/A'}</span></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Render pagination
            renderPagination(filteredData.length);
        }

        // Filter traces
        function filterTraces(traces, filters) {
            return traces.filter(trace => {
                // Search filter
                if (filters.search) {
                    const searchLower = filters.search.toLowerCase();
                    const matchesSession = trace.session_id.toLowerCase().includes(searchLower);
                    const matchesTrace = trace.trace_id.toLowerCase().includes(searchLower);
                    const matchesInput = extractUserInput(trace.input).toLowerCase().includes(searchLower);
                    const matchesOutput = extractAssistantOutput(trace.output).toLowerCase().includes(searchLower);
                    const matchesEvaluator = trace.results && trace.results.some(r =>
                        r.evaluator_id.toLowerCase().includes(searchLower)
                    );
                    if (!matchesSession && !matchesTrace && !matchesInput && !matchesOutput && !matchesEvaluator) return false;
                }

                // Evaluator filter
                if (filters.evaluator) {
                    const hasEvaluator = trace.results && trace.results.some(r =>
                        r.evaluator_id === filters.evaluator
                    );
                    if (!hasEvaluator) return false;
                }

                // Score range filter
                if (filters.scoreRange) {
                    const validScores = trace.results?.filter(r => r.value !== null && r.value !== undefined) || [];
                    if (validScores.length === 0) return false;
                    const avgScore = validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length;

                    if (filters.scoreRange === 'high' && avgScore < 0.8) return false;
                    if (filters.scoreRange === 'medium' && (avgScore < 0.5 || avgScore >= 0.8)) return false;
                    if (filters.scoreRange === 'low' && avgScore >= 0.5) return false;
                }

                return true;
            });
        }

        // Trace selection and side panel
        let selectedTraceData = null;

        function selectTrace(traceKey, index) {
            // Parse trace key
            const [sessionId, traceId] = traceKey.split('___');

            // Find the trace data
            let traceData = null;
            for (const session of evaluationData) {
                if (session.session_id === sessionId) {
                    if (session.traces) {
                        traceData = session.traces.find(t => t.trace_id === traceId);
                    }
                    if (traceData) {
                        traceData = {
                            ...traceData,
                            session_metadata: session.metadata
                        };
                    }
                    break;
                }
            }

            if (!traceData) return;

            selectedTraceData = traceData;

            // Update row selection visual
            document.querySelectorAll('.trace-row').forEach(row => row.classList.remove('selected'));
            document.querySelectorAll('.trace-row')[index]?.classList.add('selected');

            // Show side panel
            showSidePanel(traceData);
        }

        function showSidePanel(traceData) {
            const panel = document.getElementById('traceDetailPanel');
            const content = document.getElementById('sidePanelContent');

            // Extract data
            const userInput = extractUserInput(traceData.input);
            const assistantOutput = extractAssistantOutput(traceData.output);
            const validScores = traceData.results.filter(r => r.value !== null && r.value !== undefined);
            const avgScore = validScores.length > 0 ? validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length : 0;

            // Build content
            let html = '';

            // View Full Details Button (at top for easy access)
            html += '<div class="side-panel-section" style="padding-bottom: var(--space-md); border-bottom: 1px solid var(--border-color);">';
            html += `<button class="btn" style="width: 100%;" onclick='showSessionDetails("${traceData.session_id}")'>View Full Session Details</button>`;
            html += '</div>';

            // IDs Section
            html += '<div class="side-panel-section">';
            html += '<div class="side-panel-section-title">Identifiers</div>';
            html += '<div class="side-panel-content">';
            html += `<div style="margin-bottom: 0.5rem;"><strong>Session ID:</strong><br/><code style="font-size: 0.75rem; word-break: break-all;">${traceData.session_id}</code></div>`;
            html += `<div><strong>Trace ID:</strong><br/><code style="font-size: 0.75rem; word-break: break-all;">${traceData.trace_id}</code></div>`;
            html += '</div></div>';

            // Metrics Section
            html += '<div class="side-panel-section">';
            html += '<div class="side-panel-section-title">Metrics</div>';
            html += '<div class="side-panel-metrics">';
            html += '<div class="side-panel-metric">';
            html += '<div class="side-panel-metric-label">Avg Score</div>';
            html += `<div class="side-panel-metric-value">${avgScore > 0 ? avgScore.toFixed(2) : 'N/A'}</div>`;
            html += '</div>';
            html += '<div class="side-panel-metric">';
            html += '<div class="side-panel-metric-label">Evaluations</div>';
            html += `<div class="side-panel-metric-value">${traceData.results.length}</div>`;
            html += '</div>';
            html += '<div class="side-panel-metric">';
            html += '<div class="side-panel-metric-label">Total Tokens</div>';
            html += `<div class="side-panel-metric-value">${traceData.total_tokens > 0 ? traceData.total_tokens.toLocaleString() : '—'}</div>`;
            html += '</div>';
            html += '<div class="side-panel-metric">';
            html += '<div class="side-panel-metric-label">Spans</div>';
            html += `<div class="side-panel-metric-value">${traceData.span_count || '—'}</div>`;
            html += '</div>';
            html += '<div class="side-panel-metric">';
            html += '<div class="side-panel-metric-label">Latency (ms)</div>';
            html += `<div class="side-panel-metric-value">${traceData.latency_ms ? traceData.latency_ms.toLocaleString(undefined, {maximumFractionDigits: 0}) : '—'}</div>`;
            html += '</div>';
            html += '</div></div>';

            // Input Section
            html += '<div class="side-panel-section">';
            html += '<div class="side-panel-section-title">User Input</div>';
            if (userInput) {
                html += `<div class="side-panel-code">${userInput}</div>`;
            } else {
                html += '<div class="side-panel-content" style="color: var(--text-muted);">No input available</div>';
            }
            html += '</div>';

            // Output Section
            html += '<div class="side-panel-section">';
            html += '<div class="side-panel-section-title">Agent Output</div>';
            if (assistantOutput) {
                html += `<div class="side-panel-code">${assistantOutput}</div>`;
            } else {
                html += '<div class="side-panel-content" style="color: var(--text-muted);">No output available</div>';
            }
            html += '</div>';

            // Tools Section
            if (traceData.tools_used && Object.keys(traceData.tools_used).length > 0) {
                html += '<div class="side-panel-section">';
                html += '<div class="side-panel-section-title">Tools Used</div>';
                html += '<div class="side-panel-tools">';
                Object.entries(traceData.tools_used).forEach(([tool, count]) => {
                    html += `<span class="side-panel-tool-badge">${tool} × ${count}</span>`;
                });
                html += '</div></div>';
            }

            // Token Breakdown
            if (traceData.input_tokens > 0 || traceData.output_tokens > 0) {
                html += '<div class="side-panel-section">';
                html += '<div class="side-panel-section-title">Token Breakdown</div>';
                html += '<div class="side-panel-content">';
                html += `<div>Input: ${traceData.input_tokens.toLocaleString()}</div>`;
                html += `<div>Output: ${traceData.output_tokens.toLocaleString()}</div>`;
                html += `<div><strong>Total: ${traceData.total_tokens.toLocaleString()}</strong></div>`;
                html += '</div></div>';
            }

            // Evaluator Scores Section
            html += '<div class="side-panel-section">';
            html += '<div class="side-panel-section-title">Evaluator Scores</div>';
            html += '<table style="width: 100%; font-size: 0.75rem;"><tbody>';
            traceData.results.forEach(result => {
                const scoreValue = result.value !== null && result.value !== undefined ? result.value.toFixed(2) : 'N/A';
                const scoreClass = result.value >= 0.8 ? 'badge score-high' : result.value >= 0.5 ? 'badge score-medium' : 'badge score-low';
                html += '<tr>';
                html += `<td style="padding: 0.25rem 0;">${result.evaluator_name || result.evaluator_id.replace('Builtin.', '')}</td>`;
                html += `<td style="padding: 0.25rem 0; text-align: right;"><span class="${scoreClass}">${scoreValue}</span></td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div>';

            content.innerHTML = html;
            panel.classList.remove('collapsed');
        }

        function closeSidePanel() {
            const panel = document.getElementById('traceDetailPanel');
            panel.classList.add('collapsed');
            document.querySelectorAll('.trace-row').forEach(row => row.classList.remove('selected'));
            selectedTraceData = null;
        }

        function handleSort(column) {
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            renderSessions();
        }

        function renderPagination(totalItems) {
            const paginationDiv = document.getElementById('sessionsPagination');
            const pageInfo = document.getElementById('sessionsPageInfo');
            const pageControls = document.getElementById('sessionsPageControls');

            if (totalItems <= paginationState.itemsPerPage) {
                paginationDiv.classList.add('hidden');
                return;
            }

            paginationDiv.classList.remove('hidden');

            const totalPages = Math.ceil(totalItems / paginationState.itemsPerPage);
            const startItem = (paginationState.currentPage - 1) * paginationState.itemsPerPage + 1;
            const endItem = Math.min(paginationState.currentPage * paginationState.itemsPerPage, totalItems);

            pageInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} sessions`;

            let controlsHtml = `
                <button class="pagination-btn" onclick="changePage(1)" ${paginationState.currentPage === 1 ? 'disabled' : ''}>First</button>
                <button class="pagination-btn" onclick="changePage(${paginationState.currentPage - 1})" ${paginationState.currentPage === 1 ? 'disabled' : ''}>Previous</button>
            `;

            // Page numbers
            const pageRange = 2;
            for (let i = Math.max(1, paginationState.currentPage - pageRange); i <= Math.min(totalPages, paginationState.currentPage + pageRange); i++) {
                controlsHtml += `<button class="pagination-btn ${i === paginationState.currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            controlsHtml += `
                <button class="pagination-btn" onclick="changePage(${paginationState.currentPage + 1})" ${paginationState.currentPage === totalPages ? 'disabled' : ''}>Next</button>
                <button class="pagination-btn" onclick="changePage(${totalPages})" ${paginationState.currentPage === totalPages ? 'disabled' : ''}>Last</button>
            `;

            pageControls.innerHTML = controlsHtml;
        }

        function changePage(page) {
            paginationState.currentPage = page;
            renderSessions();
        }

        // Experiments rendering
        function renderExperiments() {
            const container = document.getElementById('experimentsContent');

            const experiments = {};
            evaluationData.forEach(session => {
                const expName = session.metadata?.experiment || 'default';
                if (!experiments[expName]) {
                    experiments[expName] = { sessions: [], results: [] };
                }
                experiments[expName].sessions.push(session);
                experiments[expName].results.push(...(session.results || []));
            });

            if (Object.keys(experiments).length === 0) {
                container.innerHTML = '<div class="empty-state"><div>No experiments to compare. To use this feature, run multiple evaluations with different <code>metadata.experiment</code> values (e.g., "baseline", "optimized", "experiment_v2").</div></div>';
                return;
            }

            let html = '<table><thead><tr><th>Experiment</th><th>Session IDs</th><th>Trace IDs</th><th>Evaluations</th><th>Avg Score</th><th>Success Rate</th><th>Input Tokens</th><th>Output Tokens</th></tr></thead><tbody>';

            Object.entries(experiments).forEach(([name, data]) => {
                const validScores = data.results.filter(r => r.value !== null && r.value !== undefined);
                const avgScore = validScores.length > 0 ? validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length : 0;
                const successRate = validScores.length > 0 ? (validScores.filter(r => r.value >= 0.8).length / validScores.length * 100).toFixed(1) : 0;

                // Calculate total input and output tokens
                const totalInputTokens = data.results.reduce((sum, r) => sum + (r.token_usage?.inputTokens || 0), 0);
                const totalOutputTokens = data.results.reduce((sum, r) => sum + (r.token_usage?.outputTokens || 0), 0);

                // Count unique trace IDs across all sessions in this experiment
                const uniqueTraceIds = new Set();
                data.sessions.forEach(session => {
                    if (session.traces && Array.isArray(session.traces)) {
                        session.traces.forEach(trace => {
                            if (trace.trace_id) {
                                uniqueTraceIds.add(trace.trace_id);
                            }
                        });
                    }
                });
                const traceCount = uniqueTraceIds.size;

                html += '<tr>';
                html += `<td><strong>${name}</strong></td>`;
                html += `<td>${data.sessions.length}</td>`;
                html += `<td>${traceCount}</td>`;
                html += `<td>${data.results.length}</td>`;
                html += `<td>${avgScore.toFixed(2)}</td>`;
                html += `<td>${successRate}%</td>`;
                html += `<td>${totalInputTokens.toLocaleString()}</td>`;
                html += `<td>${totalOutputTokens.toLocaleString()}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Populate timeline filters
        function populateTimelineFilters() {
            // Populate evaluator dropdown
            const evaluatorSelect = document.getElementById('timelineEvaluator');
            const uniqueEvaluators = [...new Set(allResults.map(r => r.evaluator_id))].sort();

            // Clear existing options except "All Evaluators"
            evaluatorSelect.innerHTML = '<option value="">All Evaluators</option>';
            uniqueEvaluators.forEach(evalId => {
                const option = document.createElement('option');
                option.value = evalId;
                option.textContent = evalId.replace('Builtin.', '');
                evaluatorSelect.appendChild(option);
            });

            // Populate category dropdown
            const categorySelect = document.getElementById('timelineCategory');
            const categories = Object.keys(EVALUATOR_CATEGORIES).sort();

            // Clear existing options except "All Categories"
            categorySelect.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        // Timeline rendering
        function renderTimeline() {
            const canvas = document.getElementById('timelineChart');
            const ctx = canvas.getContext('2d');

            if (charts.timeline) charts.timeline.destroy();

            // Get filter values
            const selectedEvaluator = document.getElementById('timelineEvaluator').value;
            const selectedCategory = document.getElementById('timelineCategory').value;

            // Sort sessions by timestamp if available
            const sortedSessions = [...evaluationData].sort((a, b) => {
                const timeA = a.metadata?.timestamp || a.metadata?.created_at || 0;
                const timeB = b.metadata?.timestamp || b.metadata?.created_at || 0;
                return timeA - timeB;
            });

            // Generate labels based on timestamp or fallback to run number
            const labels = sortedSessions.map((session, i) => {
                const timestamp = session.metadata?.timestamp || session.metadata?.created_at;
                if (timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                }
                return `Run ${i + 1}`;
            });

            // Calculate data based on filters
            const data = sortedSessions.map(session => {
                let resultsToAverage = session.results || [];

                // Apply evaluator filter
                if (selectedEvaluator) {
                    resultsToAverage = resultsToAverage.filter(r => r.evaluator_id === selectedEvaluator);
                }
                // Apply category filter
                else if (selectedCategory) {
                    const categoryEvaluators = EVALUATOR_CATEGORIES[selectedCategory] || [];
                    resultsToAverage = resultsToAverage.filter(r => {
                        const evalName = r.evaluator_id.replace('Builtin.', '');
                        return categoryEvaluators.includes(evalName);
                    });
                }

                const validScores = resultsToAverage.filter(r => r.value !== null && r.value !== undefined);
                return validScores.length > 0 ? validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length : null;
            });

            // Determine chart label
            let chartLabel = 'Average Score';
            if (selectedEvaluator) {
                chartLabel = selectedEvaluator.replace('Builtin.', '');
            } else if (selectedCategory) {
                chartLabel = `${selectedCategory} Average`;
            }

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.15)',
                        tension: 0.4,
                        fill: true,
                        spanGaps: true,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: '#6366f1',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                padding: 12,
                                font: { size: 12, weight: '500' },
                                color: '#0f172a'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            borderColor: 'rgba(226, 232, 240, 0.2)',
                            borderWidth: 1,
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: { color: '#64748b', font: { size: 11 } },
                            grid: { color: 'rgba(226, 232, 240, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#64748b', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Modal functions
        function showSessionDetails(sessionId) {
            const session = evaluationData.find(s => s.session_id === sessionId);
            if (!session) return;

            const results = session.results || [];
            const validScores = results.filter(r => r.value !== null && r.value !== undefined);
            const avgScore = validScores.length > 0 ? validScores.reduce((sum, r) => sum + r.value, 0) / validScores.length : 0;

            // Group results by level
            const sessionLevel = [];
            const traceMap = {};

            results.forEach(r => {
                const context = r.context?.spanContext || {};
                const traceId = context.traceId;
                const spanId = context.spanId;

                if (!traceId) {
                    // Session-level evaluator
                    sessionLevel.push(r);
                } else if (!spanId) {
                    // Trace-level evaluator
                    if (!traceMap[traceId]) {
                        traceMap[traceId] = { traceLevel: [], spans: {} };
                    }
                    traceMap[traceId].traceLevel.push(r);
                } else {
                    // Span-level evaluator
                    if (!traceMap[traceId]) {
                        traceMap[traceId] = { traceLevel: [], spans: {} };
                    }
                    if (!traceMap[traceId].spans[spanId]) {
                        traceMap[traceId].spans[spanId] = [];
                    }
                    traceMap[traceId].spans[spanId].push(r);
                }
            });

            let html = '<h2>Session Details</h2>';
            html += `<p><strong>Session ID:</strong> <code>${session.session_id}</code></p>`;
            html += `<p><strong>Evaluation Runs:</strong> ${session.evaluation_runs || 1}</p>`;
            html += `<p><strong>Total Evaluations:</strong> ${results.length}</p>`;
            html += `<p><strong>Average Score:</strong> ${avgScore.toFixed(2)}</p>`;

            if (session.metadata) {
                html += '<p><strong>Metadata:</strong></p><ul>';
                Object.entries(session.metadata).forEach(([k, v]) => {
                    html += `<li>${k}: ${v}</li>`;
                });
                html += '</ul>';
            }

            // Session-Level Evaluations
            if (sessionLevel.length > 0) {
                html += '<div class="section-level-session">';
                html += '<h3 style="margin-bottom: 1rem;">Session-Level Evaluations</h3>';
                html += renderEvaluationTable(sessionLevel);
                html += '</div>';
            }

            // Traces
            const traceIds = Object.keys(traceMap);
            if (traceIds.length > 0) {
                html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">Traces</h3>';

                traceIds.forEach((traceId, traceIdx) => {
                    const traceData = traceMap[traceId];
                    const traceEvalCount = traceData.traceLevel.length + Object.values(traceData.spans).flat().length;
                    const traceScores = [...traceData.traceLevel, ...Object.values(traceData.spans).flat()].filter(r => r.value !== null);
                    const traceAvg = traceScores.length > 0 ? (traceScores.reduce((sum, r) => sum + r.value, 0) / traceScores.length).toFixed(2) : 'N/A';

                    html += '<div class="collapsible-section section-level-trace">';
                    html += `<div class="collapsible-header" onclick="toggleCollapsible('trace-${traceIdx}')">`;
                    html += `<span class="collapsible-toggle" id="toggle-trace-${traceIdx}">▶</span>`;
                    html += `<span class="collapsible-title">Trace ${traceId.substring(0, 16)}...</span>`;
                    html += `<span class="collapsible-badge">${traceEvalCount} evaluations, avg: ${traceAvg}</span>`;
                    html += '</div>';
                    html += `<div class="collapsible-content" id="content-trace-${traceIdx}">`;

                    // Trace-Level Evaluations
                    if (traceData.traceLevel.length > 0) {
                        html += '<h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Trace-Level Evaluations</h4>';
                        html += renderEvaluationTable(traceData.traceLevel);
                    }

                    // Span-Level Evaluations
                    const spanIds = Object.keys(traceData.spans);
                    if (spanIds.length > 0) {
                        html += '<h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Span-Level Evaluations</h4>';

                        spanIds.forEach((spanId, spanIdx) => {
                            const spanResults = traceData.spans[spanId];
                            html += '<div class="collapsible-section section-level-span">';
                            html += `<div class="collapsible-header" onclick="toggleCollapsible('span-${traceIdx}-${spanIdx}')">`;
                            html += `<span class="collapsible-toggle" id="toggle-span-${traceIdx}-${spanIdx}">▶</span>`;
                            html += `<span class="collapsible-title">Span ${spanId.substring(0, 16)}...</span>`;
                            html += `<span class="collapsible-badge">${spanResults.length} evaluations</span>`;
                            html += '</div>';
                            html += `<div class="collapsible-content" id="content-span-${traceIdx}-${spanIdx}">`;
                            html += renderEvaluationTable(spanResults);
                            html += '</div>';
                            html += '</div>';
                        });
                    }

                    html += '</div>';
                    html += '</div>';
                });
            }

            showModal(html);
        }

        function renderEvaluationTable(results) {
            let html = '<table class="evaluation-table"><tbody>';

            results.forEach((r, idx) => {
                const scoreClass = r.value !== null && r.value !== undefined
                    ? (r.value >= 0.8 ? 'badge score-high' : r.value >= 0.5 ? 'badge score-medium' : 'badge score-low')
                    : '';
                const scoreDisplay = r.value !== null && r.value !== undefined ? r.value.toFixed(2) : 'N/A';
                const explanation = r.explanation || 'No explanation provided';
                const needsTruncation = explanation.length > 200;

                html += '<tr>';
                html += `<td class="eval-name">${r.evaluator_name || r.evaluator_id.replace('Builtin.', '')}</td>`;
                html += `<td class="eval-score"><span class="${scoreClass}">${scoreDisplay}</span></td>`;
                html += '<td>';
                html += `<div><strong>Label:</strong> ${r.label || 'N/A'}</div>`;
                html += `<div class="eval-explanation" style="white-space: pre-wrap; word-wrap: break-word;">`;
                // Always show full explanation without truncation
                html += explanation;
                html += '</div>';
                html += `<div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Tokens: ${r.token_usage?.totalTokens || 0}</div>`;
                html += '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function toggleCollapsible(id) {
            const content = document.getElementById(`content-${id}`);
            const toggle = document.getElementById(`toggle-${id}`);

            if (content && toggle) {
                const isExpanded = content.classList.contains('expanded');
                if (isExpanded) {
                    content.classList.remove('expanded');
                    toggle.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    toggle.classList.add('expanded');
                }
            }
        }

        function toggleExplanation(idx) {
            const truncated = document.getElementById(`explanation-${idx}`);
            const full = document.getElementById(`explanation-full-${idx}`);
            const btn = event.target;

            if (truncated && full) {
                if (truncated.style.display !== 'none') {
                    truncated.style.display = 'none';
                    full.style.display = 'block';
                    btn.textContent = 'Show less';
                } else {
                    truncated.style.display = 'block';
                    full.style.display = 'none';
                    btn.textContent = 'Show more';
                }
            }
        }

        function showModal(html) {
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Export functions
        function exportToCSV() {
            let csv = 'Session ID,Evaluation Runs,Evaluator,Score,Label,Tokens\n';

            evaluationData.forEach(session => {
                (session.results || []).forEach(r => {
                    csv += `"${session.session_id}",${session.evaluation_runs || 1},"${r.evaluator_id}",${r.value || ''},"${r.label || ''}",${r.token_usage?.totalTokens || 0}\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'evaluation_results.csv';
            a.click();
        }

        // Modal click outside to close
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Side panel click outside to close
        document.addEventListener('click', function(e) {
            const tracePanel = document.getElementById('traceDetailPanel');
            const sidePanel = tracePanel?.querySelector('.side-panel');

            // Check if panel is open and click is outside the panel content
            if (tracePanel && !tracePanel.classList.contains('collapsed')) {
                if (sidePanel && !sidePanel.contains(e.target)) {
                    // Also check that we're not clicking on a trace row (which opens the panel)
                    if (!e.target.closest('.trace-row')) {
                        closeSidePanel();
                    }
                }
            }
        });

        // Keyboard Navigation
        document.addEventListener('keydown', function(e) {
            // ESC to close modal or side panel
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal');
                const sidePanel = document.getElementById('traceDetailPanel');

                if (modal.classList.contains('active')) {
                    closeModal();
                } else if (sidePanel && !sidePanel.classList.contains('collapsed')) {
                    closeSidePanel();
                }
            }

            // / to focus search (when not in input)
            if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                const searchInput = document.getElementById('sessionsSearch');
                if (searchInput && !searchInput.closest('.tab-content').classList.contains('hidden')) {
                    searchInput.focus();
                }
            }

            // Arrow keys for tab navigation (Alt + Arrow)
            if (e.altKey && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                e.preventDefault();
                const tabs = Array.from(document.querySelectorAll('.tab'));
                const activeTab = document.querySelector('.tab.active');
                const currentIndex = tabs.indexOf(activeTab);

                let newIndex;
                if (e.key === 'ArrowLeft') {
                    newIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                } else {
                    newIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                }

                tabs[newIndex].click();
                tabs[newIndex].focus();
            }

            // Arrow keys for pagination (when not focused on an input)
            if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'SELECT') {
                if (e.key === 'ArrowLeft' && paginationState.currentPage > 1) {
                    changePage(paginationState.currentPage - 1);
                } else if (e.key === 'ArrowRight') {
                    const totalPages = Math.ceil(paginationState.totalItems / paginationState.itemsPerPage);
                    if (paginationState.currentPage < totalPages) {
                        changePage(paginationState.currentPage + 1);
                    }
                }
            }
        });

        // Announce dynamic content changes for screen readers
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            setTimeout(() => announcement.remove(), 1000);
        }

        // Initialize
        setupFileHandlers();

        // Auto-load data if available
        window.addEventListener('DOMContentLoaded', function() {
            // Add ARIA labels to interactive elements
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                tab.setAttribute('role', 'tab');
                tab.setAttribute('aria-label', `Tab ${index + 1}: ${tab.textContent}`);
                tab.setAttribute('tabindex', tab.classList.contains('active') ? '0' : '-1');
            });

            if (typeof EVALUATION_DATA !== 'undefined' && EVALUATION_DATA && EVALUATION_DATA.length > 0) {
                console.log(`Auto-loading ${EVALUATION_DATA.length} session(s)`);
                evaluationData = EVALUATION_DATA;
                showSuccess(`Auto-loaded ${evaluationData.length} session(s) from dashboard_data.js`);
                initializeDashboard();
                announceToScreenReader(`Dashboard loaded with ${evaluationData.length} sessions`);
            }
        });
    </script>
</body>
</html>
