## Current Architecture
# SRE Workshop Infrastructure Architecture

## System Context
You are troubleshooting a 3-tier web application deployed on AWS. The infrastructure consists of two separate application flows: a main Python application and a CRM demo application, both with complete observability through CloudWatch.

## Network Architecture

### VPC Configuration
- VPC CIDR: 10.0.0.0/16
- Public Subnets: 10.0.1.0/24 (AZ1), 10.0.2.0/24 (AZ2)
- Private Subnets: 10.0.10.0/24 (AZ1), 10.0.11.0/24 (AZ2)
- Internet Gateway: Attached to VPC for public internet access
- NAT Gateway: Located in PublicSubnet1 for private subnet egress

## Application Flow 1: Main Python Application (3-Tier)

### Traffic Path
```
Internet (Port 80)
  ↓
Public ALB (sre-workshop-public-alb)
  - Type: internet-facing
  - Subnets: PublicSubnet1, PublicSubnet2
  - Security Group: PublicALBSecurityGroup (allows 0.0.0.0/0 → 80, 443, 8080)
  - Listener: Port 80 → PublicALBTargetGroup
  ↓
Nginx Instance (NginxInstance1) - WEB TIER
  - Instance Type: t3.micro
  - Subnet: PrivateSubnet1 (10.0.10.0/24)
  - Security Group: NginxSecurityGroup (allows PublicALBSecurityGroup → 80)
  - Role: Reverse proxy to backend services
  - Health Check: /health endpoint
  ↓
Private ALB (sre-workshop-private-alb)
  - Type: internal
  - Subnets: PrivateSubnet1, PrivateSubnet2
  - Security Group: PrivateALBSecurityGroup (allows NginxSecurityGroup → 80)
  - Listener: Port 80 → PrivateALBTargetGroup
  ↓
Python App Server (AppServerInstance1) - APPLICATION TIER
  - Instance Type: t3.micro
  - Subnet: PrivateSubnet1 (10.0.10.0/24)
  - Port: 8080
  - Security Group: AppServerSecurityGroup (allows PrivateALBSecurityGroup → 8080)
  - Application: Python Flask/Gunicorn app
  - Health Check: /health endpoint
  ↓
DynamoDB (ApplicationMetricsTable) - DATA TIER
  - Partition Key: metric_id (String)
  - Sort Key: timestamp (Number)
  - Purpose: Application metrics storage
```

### Nginx Instance Details
- **IAM Role**: EC2InstanceRole
  - SSM managed instance access
  - CloudWatch agent permissions
  - S3 read access to AssetsBucketName
  - DynamoDB read/write to ApplicationMetricsTable
- **Configuration Source**: Downloads nginx.conf from S3 (nginx-assets.zip)
- **Dynamic Config**: Replaces PRIVATE_ALB_DNS_PLACEHOLDER with actual Private ALB DNS
- **Logs**: 
  - Access logs → /aws/sre-workshop/nginx/access
  - Error logs → /aws/sre-workshop/nginx/error
- **Monitoring**: CloudWatch agent sends metrics

### Python App Server Details
- **IAM Role**: EC2InstanceRole
  - DynamoDB access to ApplicationMetricsTable
  - CloudWatch agent permissions
  - S3 read access to AssetsBucketName
- **Application Source**: Downloads sre-app.zip from S3
- **Environment Variables**:
  - AWS_REGION: Current region
  - METRICS_TABLE: ApplicationMetricsTable name
- **Service**: Systemd service (sre-app.service)
- **Logs**: Application logs → /aws/sre-workshop/application
- **Monitoring**: CloudWatch agent sends metrics

## Application Flow 2: CRM Demo Application

### Traffic Path
```
Internet (Port 8080)
  ↓
Public ALB (sre-workshop-public-alb)
  - Same ALB as main app
  - Listener: Port 8080 → CRMAppTargetGroup
  ↓
CRM App Instance (CRMAppInstance)
  - Instance Type: t3.micro
  - Subnet: PrivateSubnet1 (10.0.10.0/24)
  - Port: 8080
  - Security Group: CRMAppSecurityGroup (allows PublicALBSecurityGroup → 8080)
  - Application: Python Flask/Gunicorn CRM app (2 workers)
  - Health Check: /health endpoint
  ↓
DynamoDB Tables (3 tables):
  1. CRMCustomersTable
  2. CRMDealsTable
  3. CRMActivitiesTable
```

### CRM Instance Details
- **IAM Role**: EC2InstanceRole
  - DynamoDB access to all 3 CRM tables
  - CloudWatch agent permissions
  - S3 read access to AssetsBucketName
- **Application Source**: Downloads crm-app.zip from S3
- **Environment Variables**:
  - AWS_REGION: Current region
  - CUSTOMERS_TABLE: CRMCustomersTable name
  - DEALS_TABLE: CRMDealsTable name
  - ACTIVITIES_TABLE: CRMActivitiesTable name
- **Initialization**: Runs init_sample_data.py to populate sample data
- **Service**: Systemd service (crm-app.service)
- **Tags**: DeploymentVersion: "2.0"

### CRM Data Model
```
CRMCustomersTable
  - Partition Key: customer_id (String)
  - Contains: Customer profile information

CRMDealsTable
  - Partition Key: deal_id (String)
  - Global Secondary Index: customer-index
    - Hash Key: customer_id
  - Relationship: One customer → Many deals

CRMActivitiesTable
  - Partition Key: activity_id (String)
  - Global Secondary Index: customer-index
    - Hash Key: customer_id
  - Relationship: One customer → Many activities
```

## Additional DynamoDB Tables

### IncidentHistoryTable
- Partition Key: incident_id (String)
- Sort Key: occurred_at (Number)
- Purpose: Historical incident tracking for SRE analysis

## Security Group Chain

### Main Application Security Flow
```
PublicALBSecurityGroup
  - Ingress: 0.0.0.0/0 → 80, 443, 8080
  ↓ allows traffic to
NginxSecurityGroup
  - Ingress: PublicALBSecurityGroup → 80
  ↓ allows traffic to
PrivateALBSecurityGroup
  - Ingress: NginxSecurityGroup → 80
  ↓ allows traffic to
AppServerSecurityGroup
  - Ingress: PrivateALBSecurityGroup → 8080
```

### CRM Application Security Flow
```
PublicALBSecurityGroup
  - Ingress: 0.0.0.0/0 → 8080
  ↓ allows traffic to
CRMAppSecurityGroup
  - Ingress: PublicALBSecurityGroup → 8080
```

## Internet Connectivity for Private Instances

All private instances (Nginx, App Server, CRM) access the internet through:
```
Private Instance
  ↓
Private Route Table (0.0.0.0/0 → NAT Gateway)
  ↓
NAT Gateway (in PublicSubnet1)
  ↓
Internet Gateway
  ↓
Internet (for package downloads, AWS API calls, S3 access)
```

## Observability Stack

### CloudWatch Log Groups
- `/aws/sre-workshop/application` - Python app logs
- `/aws/sre-workshop/nginx/access` - Nginx access logs
- `/aws/sre-workshop/nginx/error` - Nginx error logs
- Retention: 7 days for all log groups

### CloudWatch Metrics
All EC2 instances run CloudWatch agent sending:
- CPU utilization
- Memory usage
- Disk I/O
- Network traffic
- Custom application metrics

sre-workshop-crm-app [EC2] has python app running from file /opt/crm-app/app.py 

sre-workshop-app [EC2] has python app running from file /opt/sre-app/app.py


Public ALB [sre-workshop-public-alb] -> Port 80 -> Nginx service provides back end checks in json response like below:

{
memory_leak_size_mb: 6,
message: "SRE Workshop App",
timestamp: "2025-11-27T19:49:51.201108"
}

keep an eye on memory leak

## IAM Roles and Permissions

### EC2InstanceRole (Used by all EC2 instances)
Managed Policies:
- AmazonSSMManagedInstanceCore (remote access via Session Manager)
- CloudWatchAgentServerPolicy (metrics and logs)

Inline Policies:
- DynamoDB access (PutItem, GetItem, Query, Scan, UpdateItem, DeleteItem, BatchWriteItem)
- S3 read access to LambdaS3Bucket and AssetsBucketName