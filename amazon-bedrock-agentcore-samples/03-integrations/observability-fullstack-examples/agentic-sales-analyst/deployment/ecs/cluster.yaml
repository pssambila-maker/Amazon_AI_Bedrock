AWSTemplateFormatVersion: '2010-09-09'
Description: 'ECS cluster and ALB for Strands Agent'

Parameters:
  ProjectName:
    Type: String
    Default: agentic-sales-analyst

Resources:
  ALBLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${ProjectName}-alb-logs-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  ALBLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ALBLogsBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: logdelivery.elasticloadbalancing.amazonaws.com
            Action: 's3:PutObject'
            Resource: !Sub 'arn:aws:s3:::${ALBLogsBucket}/AWSLogs/${AWS::AccountId}/*'
          - Effect: Allow
            Principal:
              Service: logdelivery.elasticloadbalancing.amazonaws.com
            Action: 's3:GetBucketAcl'
            Resource: !Sub 'arn:aws:s3:::${ALBLogsBucket}'

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${ProjectName}-alb-sg
      GroupDescription: ALB security group
      VpcId: !ImportValue
        Fn::Sub: ${ProjectName}-vpc-id
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0  # checkov:skip=CKV_AWS_260:Demo application requires public HTTP access
          Description: Allow HTTP from internet (demo application)
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0  # checkov:skip=CKV_AWS_260:ALB requires all outbound access for health checks and routing
          Description: Allow all outbound traffic for ALB functionality

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${ProjectName}-ecs-sg
      GroupDescription: ECS tasks security group
      VpcId: !ImportValue
        Fn::Sub: ${ProjectName}-vpc-id
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS outbound for API calls
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP outbound for API calls
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          CidrIp: 10.0.0.0/16
          Description: Allow NFS outbound to EFS

  ECSSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ECSSecurityGroup
      IpProtocol: tcp
      FromPort: 3000
      ToPort: 3000
      SourceSecurityGroupId: !Ref ALBSecurityGroup
      Description: Allow frontend traffic from ALB

  Cluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub ${ProjectName}-cluster
      CapacityProviders:
        - FARGATE
      ClusterSettings:
        - Name: containerInsights
          Value: enabled

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DependsOn: ALBLogsBucketPolicy
    Properties:
      Name: !Sub ${ProjectName}-alb
      Type: application
      Scheme: internet-facing
      Subnets:
        - !ImportValue
          Fn::Sub: ${ProjectName}-subnet-1-id
        - !ImportValue
          Fn::Sub: ${ProjectName}-subnet-2-id
      SecurityGroups:
        - !Ref ALBSecurityGroup
      LoadBalancerAttributes:
        - Key: routing.http.drop_invalid_header_fields.enabled
          Value: 'true'
        - Key: access_logs.s3.enabled
          Value: 'true'
        - Key: access_logs.s3.bucket
          Value: !Ref ALBLogsBucket

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${ProjectName}-tg
      Port: 3000
      Protocol: HTTP
      TargetType: ip
      VpcId: !ImportValue
        Fn::Sub: ${ProjectName}-vpc-id
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 30

  # HTTP Listener (sample only - add HTTPS for production)
  # For HTTPS: Create ACM certificate, add port 443 listener with certificate ARN
  # See: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html
  Listener:  # checkov:skip=CKV_AWS_103,CKV_AWS_2:Demo application uses HTTP for simplicity
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  LogGroup:  # checkov:skip=CKV_AWS_158:Demo application uses default CloudWatch encryption
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/bedrock-agentcore/runtimes/${ProjectName}
      RetentionInDays: 7

Outputs:
  ClusterName:
    Value: !Ref Cluster
    Export:
      Name: !Sub ${ProjectName}-cluster-name
  ECSSecurityGroupId:
    Value: !Ref ECSSecurityGroup
    Export:
      Name: !Sub ${ProjectName}-ecs-sg-id
  TargetGroupArn:
    Value: !Ref TargetGroup
    Export:
      Name: !Sub ${ProjectName}-tg-arn
  ALBDNSName:
    Value: !GetAtt ALB.DNSName
    Export:
      Name: !Sub ${ProjectName}-alb-dns
  LogGroupName:
    Value: !Ref LogGroup
    Export:
      Name: !Sub ${ProjectName}-log-group
